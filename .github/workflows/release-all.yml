name: Build & Release (Windows + macOS)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.41.2'

jobs:
  build-macos:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (macOS)
        run: |
          set -euo pipefail
          VERSION="${{ env.FLUTTER_VERSION }}"
          ARCH="$(uname -m)"
          if [[ "$ARCH" == "arm64" ]]; then
            FLUTTER_ARCH="arm64"
          else
            FLUTTER_ARCH="x64"
          fi

          ZIP_URL="https://storage.googleapis.com/flutter_infra_release/releases/stable/macos/flutter_macos_${FLUTTER_ARCH}_${VERSION}-stable.zip"
          ZIP_PATH="$RUNNER_TEMP/flutter.zip"
          INSTALL_ROOT="$RUNNER_TEMP/flutter-sdk"

          curl -L "$ZIP_URL" -o "$ZIP_PATH"
          unzip -q "$ZIP_PATH" -d "$INSTALL_ROOT"

          echo "FLUTTER_BIN=$INSTALL_ROOT/flutter/bin" >> "$GITHUB_ENV"
          echo "$INSTALL_ROOT/flutter/bin" >> "$GITHUB_PATH"

      - name: Verify Flutter version
        run: |
          "$FLUTTER_BIN/flutter" --version
          "$FLUTTER_BIN/dart" --version

      - name: Enable full local LLM for release build
        run: |
          cp full/local_llm_service.dart lib/services/local_llm_service.dart
          if ! grep -qE '^\s*llamadart:' pubspec.yaml; then
            sed -i.bak '/ffi: \^2.1.0/a\  llamadart: ^0.6.2' pubspec.yaml
          fi

      - name: Get dependencies
        run: |
          "$FLUTTER_BIN/flutter" pub get

      - name: Analyze
        run: |
          "$FLUTTER_BIN/flutter" analyze --no-fatal-infos

      - name: Build macOS Release
        run: |
          "$FLUTTER_BIN/flutter" build macos --release

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep -E '^version:' pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
          VERSION=${VERSION:-0.0.0}
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Package DMG
        id: package
        run: |
          APP_PATH="$(find build/macos/Build/Products/Release -maxdepth 1 -name '*.app' -print -quit)"
          if [[ -z "$APP_PATH" ]]; then
            echo "No .app found in build output." >&2
            exit 1
          fi

          # 统一架构可执行文件校验
          APP_BIN="$APP_PATH/Contents/MacOS/$(basename "$APP_PATH" .app)"
          file "$APP_BIN"

          # 关键 Flutter 资源存在性校验
          test -f "$APP_PATH/Contents/Frameworks/App.framework/Resources/flutter_assets/AssetManifest.bin" || (echo "Missing flutter_assets" >&2; exit 1)
          test -f "$APP_PATH/Contents/Frameworks/FlutterMacOS.framework/Versions/A/FlutterMacOS" || (echo "Missing FlutterMacOS framework" >&2; exit 1)

          APP_NAME="$(basename "$APP_PATH" .app)"
          VERSION="${{ steps.version.outputs.VERSION }}"
          DMG_NAME="${APP_NAME}-macos-${VERSION}.dmg"

          STAGE_DIR="$RUNNER_TEMP/dmg-stage"
          rm -rf "$STAGE_DIR"
          mkdir -p "$STAGE_DIR"
          cp -R "$APP_PATH" "$STAGE_DIR/"

          hdiutil create -volname "$APP_NAME" -srcfolder "$STAGE_DIR" -ov -format UDZO "build/$DMG_NAME"

          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: build/${{ steps.package.outputs.DMG_NAME }}
          retention-days: 7

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "${{ env.FLUTTER_VERSION }}"
          $zipUrl = "https://storage.googleapis.com/flutter_infra_release/releases/stable/windows/flutter_windows_${version}-stable.zip"
          $zipPath = "$env:RUNNER_TEMP/flutter.zip"
          $installRoot = "$env:RUNNER_TEMP/flutter-sdk"

          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $installRoot -Force

          $flutterBin = "$installRoot/flutter/bin"
          "FLUTTER_BIN=$flutterBin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$flutterBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Flutter version
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" --version
          & "$env:FLUTTER_BIN/dart.bat" --version

      - name: Enable full local LLM for release build
        shell: pwsh
        run: |
          Copy-Item -Force "full/local_llm_service.dart" "lib/services/local_llm_service.dart"
          $content = Get-Content "pubspec.yaml" -Raw
          if ($content -notmatch '(?m)^\s*llamadart:\s*') {
            $content = $content -replace "(?m)^(\s*ffi:\s*\^2\.1\.0\s*)$", "$1`r`n  llamadart: ^0.6.2"
            Set-Content "pubspec.yaml" -Value $content -NoNewline
          }

      - name: Get dependencies
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" pub get

      - name: Analyze
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" analyze --no-fatal-infos

      - name: Build Windows Release
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" build windows --release

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $match = Select-String -Path "pubspec.yaml" -Pattern '^version:\s*([^\s+]+)'
          $ver = if ($match.Matches.Count -gt 0) { $match.Matches[0].Groups[1].Value } else { "0.0.0" }
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT

      - name: Package release artifacts
        shell: pwsh
        id: package
        run: |
          $releaseDir = Get-ChildItem "build\windows" -Recurse -Directory |
            Where-Object { $_.Name -eq 'Release' -and $_.FullName -match 'runner' } |
            Select-Object -First 1
          if (-not $releaseDir) {
            throw "Release directory not found"
          }
          $version = "${{ steps.version.outputs.VERSION }}"
          $zipName = "voicetype-windows-$version.zip"
          Compress-Archive -Path "$($releaseDir.FullName)\*" -DestinationPath "build\$zipName" -Force
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_OUTPUT

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: build/${{ steps.package.outputs.ZIP_NAME }}
          retention-days: 7

  build-windows-simple:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "${{ env.FLUTTER_VERSION }}"
          $zipUrl = "https://storage.googleapis.com/flutter_infra_release/releases/stable/windows/flutter_windows_${version}-stable.zip"
          $zipPath = "$env:RUNNER_TEMP/flutter.zip"
          $installRoot = "$env:RUNNER_TEMP/flutter-sdk"

          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $installRoot -Force

          $flutterBin = "$installRoot/flutter/bin"
          "FLUTTER_BIN=$flutterBin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$flutterBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Replace local model services with stubs
        shell: pwsh
        run: |
          Copy-Item -Force "simple/whisper_cpp_service.dart" "lib/services/whisper_cpp_service.dart"
          Copy-Item -Force "simple/local_llm_service.dart" "lib/services/local_llm_service.dart"

      - name: Patch pubspec.yaml to remove native dependencies
        shell: pwsh
        run: |
          $content = Get-Content "pubspec.yaml" -Raw
          $content = $content -replace '(?m)^\s*whisper_flutter_new:.*\r?\n', ''
          $content = $content -replace '(?m)^\s*llamadart:.*\r?\n', ''
          $content = $content -replace '(?m)^\s*ffi:.*\r?\n', ''
          Set-Content "pubspec.yaml" -Value $content -NoNewline

      - name: Get dependencies
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" pub get

      - name: Analyze
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" analyze --no-fatal-infos

      - name: Build Windows Release
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" build windows --release

      - name: Package release artifacts
        shell: pwsh
        id: package
        run: |
          $releaseDir = Get-ChildItem "build\windows" -Recurse -Directory |
            Where-Object { $_.Name -eq 'Release' -and $_.FullName -match 'runner' } |
            Select-Object -First 1
          if (-not $releaseDir) {
            throw "Release directory not found"
          }
          $zipName = "voicetype-windows-simple-version.zip"
          Compress-Archive -Path "$($releaseDir.FullName)\*" -DestinationPath "build\$zipName" -Force
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_OUTPUT

      - name: Upload Windows Simple artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows-simple
          path: build/${{ steps.package.outputs.ZIP_NAME }}
          retention-days: 7

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-macos, build-windows, build-windows-simple]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: release-macos
          path: release-assets

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: release-windows
          path: release-assets

      - name: Download Windows Simple artifact
        uses: actions/download-artifact@v4
        with:
          name: release-windows-simple
          path: release-assets

      - name: Check existing GitHub Release
        id: check_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            try {
              const { data } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag,
              });
              core.info(`Release ${tag} already exists (id=${data.id}), skip upload to avoid immutable release error.`);
              core.setOutput('exists', 'true');
            } catch (error) {
              if (error.status === 404) {
                core.info(`Release ${tag} not found, will create a new one.`);
                core.setOutput('exists', 'false');
              } else {
                throw error;
              }
            }

      - name: Create GitHub Release (both assets)
        if: steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-assets/*.dmg
            release-assets/*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
