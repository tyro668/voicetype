name: Build Windows Installer

on:
  workflow_dispatch:    # 手动构建（发布由 unified workflow 处理）

env:
  FLUTTER_VERSION: '3.41.2'   # 需匹配 Dart SDK ^3.10.8

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "${{ env.FLUTTER_VERSION }}"
          $zipUrl = "https://storage.googleapis.com/flutter_infra_release/releases/stable/windows/flutter_windows_${version}-stable.zip"
          $zipPath = "$env:RUNNER_TEMP/flutter.zip"
          $installRoot = "$env:RUNNER_TEMP/flutter-sdk"

          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath $installRoot -Force

          $flutterBin = "$installRoot/flutter/bin"
          "FLUTTER_BIN=$flutterBin" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "$flutterBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Flutter version
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" --version
          & "$env:FLUTTER_BIN/dart.bat" --version

      - name: Flutter doctor
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" doctor -v

      - name: Enable full local LLM for release build
        shell: pwsh
        run: |
          Copy-Item -Force "full/local_llm_service.dart" "lib/services/local_llm_service.dart"
          $content = Get-Content "pubspec.yaml" -Raw
          if ($content -notmatch '(?m)^\s*llamadart:\s*') {
            $content = $content -replace "(?m)^(\s*ffi:\s*\^2\.1\.0\s*)$", "$1`r`n  llamadart: ^0.6.2"
            Set-Content "pubspec.yaml" -Value $content -NoNewline
          }

      - name: Get dependencies
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" pub get

      - name: Analyze
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" analyze --no-fatal-infos

      - name: Build Windows Release
        shell: pwsh
        run: |
          & "$env:FLUTTER_BIN/flutter.bat" build windows --release

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $match = Select-String -Path "pubspec.yaml" -Pattern '^version:\s*([^\s+]+)'
          $ver = if ($match.Matches.Count -gt 0) { $match.Matches[0].Groups[1].Value } else { "0.0.0" }
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT
          echo "Version: $ver"

      - name: Package release artifacts
        shell: pwsh
        run: |
          $releaseDir = Get-ChildItem "build\windows" -Recurse -Directory |
            Where-Object { $_.Name -eq 'Release' -and $_.FullName -match 'runner' } |
            Select-Object -First 1
          if (-not $releaseDir) {
            throw "Release directory not found"
          }
          $version = "${{ steps.version.outputs.VERSION }}"
          $zipName = "offhand-windows-$version.zip"
          Compress-Archive -Path "$($releaseDir.FullName)\*" -DestinationPath "build\$zipName" -Force
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_OUTPUT
          echo "ZIP_PATH=build\$zipName" >> $env:GITHUB_OUTPUT
          echo "Packaged: build\$zipName"
        id: package

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: offhand-windows-${{ steps.version.outputs.VERSION }}
          path: build/${{ steps.package.outputs.ZIP_NAME }}
          retention-days: 30

      - name: Check existing GitHub Release
        id: check_release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            try {
              const { data } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag,
              });
              core.info(`Release ${tag} already exists (id=${data.id}), skip upload to avoid immutable release error.`);
              core.setOutput('exists', 'true');
            } catch (error) {
              if (error.status === 404) {
                core.info(`Release ${tag} not found, will create a new one.`);
                core.setOutput('exists', 'false');
              } else {
                throw error;
              }
            }

      # 仅在 tag 推送时创建 GitHub Release
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/') && steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: build/${{ steps.package.outputs.ZIP_NAME }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
