name: Build Windows Installer

on:
  push:
    tags:
      - 'v*'          # 推送 v* 标签时自动构建
  workflow_dispatch:    # 也支持手动触发

env:
  FLUTTER_VERSION: '3.32.2'   # 与本地开发环境保持一致

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Build Windows Release
        run: flutter build windows --release

      - name: Extract version
        id: version
        shell: pwsh
        run: |
          $match = Select-String -Path "pubspec.yaml" -Pattern '^version:\s*([^\s+]+)'
          $ver = if ($match.Matches.Count -gt 0) { $match.Matches[0].Groups[1].Value } else { "0.0.0" }
          echo "VERSION=$ver" >> $env:GITHUB_OUTPUT
          echo "Version: $ver"

      - name: Package release artifacts
        shell: pwsh
        run: |
          $releaseDir = Get-ChildItem "build\windows" -Recurse -Directory |
            Where-Object { $_.Name -eq 'Release' -and $_.FullName -match 'runner' } |
            Select-Object -First 1
          if (-not $releaseDir) {
            throw "Release directory not found"
          }
          $version = "${{ steps.version.outputs.VERSION }}"
          $zipName = "voicetype-windows-$version.zip"
          Compress-Archive -Path "$($releaseDir.FullName)\*" -DestinationPath "build\$zipName" -Force
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_OUTPUT
          echo "ZIP_PATH=build\$zipName" >> $env:GITHUB_OUTPUT
          echo "Packaged: build\$zipName"
        id: package

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: voicetype-windows-${{ steps.version.outputs.VERSION }}
          path: build/${{ steps.package.outputs.ZIP_NAME }}
          retention-days: 30

      # 仅在 tag 推送时创建 GitHub Release
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build/${{ steps.package.outputs.ZIP_NAME }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
