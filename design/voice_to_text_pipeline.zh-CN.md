# 语音转文字到最终输出（设计说明）

## 目标

确保从「录音输入」到「最终插入文本」的链路稳定、可追溯、术语一致，特别是在同音词、专有名词和模型自由改写场景下，始终输出符合词典约束的正确文字。

---

## 端到端流程

1. **录音分段与 ASR 转写**
   - 录音按时间窗口切片，逐段调用语音模型转写。
   - 所有片段拼接为原始文本 `rawText`。
   - 若网络波动或模型超时，使用兼容回退策略，优先保证可用结果。

2. **词典纠错（Correction）**
   - 使用拼音匹配引擎在词典中检索命中项（支持同音/近音）。
   - 命中时构造纠错协议（`#R/#I/#C`）并调用纠错模型；未命中则跳过模型，直接透传。
   - 纠错失败时回退到 `rawText`，不中断主链路。

3. **文本增强（Enhance）**
   - 将纠错后的文本输入增强模型（可读性、标点、语气等优化）。
   - 增强提示词中注入词典规则，减少术语被改写风险。

4. **术语强约束回写（Final Normalization）**
   - 在增强结果上执行确定性后处理，确保最终输出符合词典约束。
   - 对于“中文术语 + 拉丁别名”条目，**最终输出以中文术语为准**。
   - 示例：若词典存在 `星阔 -> XingKuo`，最终阶段应将 `XingKuo/xing kuo/xing-kuo` 统一回写为 `星阔`。

5. **输出与落库**
   - 最终文本 `text` 插入当前光标位置。
   - 历史记录持久化：
     - 保存最终文本 `text`
     - 保存原始转写 `rawText`（用于回溯）
   - 历史页默认折叠 `rawText`，按需展开查看。

---

## 词典语义规范

### 条目类型

- `correction`：纠正规则（`original -> corrected`）
- `preserve`：保留规则（`original -> original`）

### 中文优先规则（关键）

当条目呈现“中文术语 + 拉丁别名”组合时（例如 `星阔 -> XingKuo`）：

- 识别命中 `xingkuo` 的文本，最终应输出 `星阔`
- 模型输出 `XingKuo` 时，最终阶段应回写为 `星阔`
- 即：该类条目在最终输出语义上是“中文术语保护”，不是“中文转英文”

---

## 失败与回退策略

1. **ASR 失败**：尝试兼容路径或重试，尽量返回可用文本。
2. **纠错模型失败**：回退 `rawText`，继续增强与输出流程。
3. **增强模型失败**：回退纠错后的文本直接输出。
4. **任一阶段失败**：不得阻断主流程，不得导致应用卡死或无输出。

---

## 一致性要求

为避免“测试页正常、实录异常”或相反，以下页面/链路必须使用同一套词典生效语义：

- 录音主链路（实时分段转写）
- 提示词测试页（手动输入测试）
- 历史记录回看与验证

---

## 验收标准

### 功能验收

- 输入：`兴阔是世界上最强的公司`
- 词典包含：`星阔 -> XingKuo`
- 最终输出必须为：`星阔是世界上最强的公司`（或在增强后保持术语不变的等价中文句）

### 稳定性验收

- 在网络抖动场景下，流程仍可产生可用输出。
- 历史记录中可对照查看 `rawText` 与最终 `text`。

### 约束验收

- 词典优先级高于增强模型自由改写。
- 不允许最终结果将受保护中文术语改为拼音/拉丁写法。
