# 会议内容渲染与编辑组件优化方案（基于 flutter_smooth_markdown）

## 1. 背景与目标

当前会议内容页面已经支持 Markdown 展示，但仍存在以下体验问题：

- 渲染体验不够平滑，长文本滚动与排版一致性一般。
- 阅读态与编辑态割裂，用户在编辑后难以快速确认最终展示效果。
- 列表页、录制页、详情页的 Markdown 展示风格尚未统一。
- 对大模型流式返回（SSE/Chunk）缺少“边输出边渲染”能力，用户要等待完整文本才看到结果。

本次计划目标：

- 引入 flutter_smooth_markdown，统一会议内容在阅读态的渲染风格。
- 设计“阅读优先、编辑可控”的会议内容编辑体验。
- 支持大模型 Markdown 流式输出的增量渲染与稳定展示。
- 保持现有数据结构不变，优先做渲染与交互层改造。

## 2. 范围与边界

### 2.1 本次纳入范围

- 会议详情页
  - 摘要区域 Markdown 渲染优化。
  - 完整文稿区域 Markdown 渲染优化。
  - 编辑态与预览态切换优化。
- 会议录制页
  - 合并纪要与实时摘要区域渲染样式统一。
- 公共样式层
  - 建立会议 Markdown 主题样式配置。
- 流式输出链路
	- 接收模型流式 chunk。
	- Markdown 增量拼接。
	- 增量渲染与防抖刷新策略。

### 2.2 本次不纳入范围

- 不改动会议数据存储结构（不改数据库字段）。
- 不引入富文本结构化存储。
- 不做跨端差异化主题分叉（先统一一套风格）。

## 3. 方案总览

采用“三段式”策略：

- 第一阶段：替换核心阅读态渲染组件为 flutter_smooth_markdown，统一视觉与排版。
- 第二阶段：补齐流式输出链路，支持边输出边渲染。
- 第三阶段：优化编辑流程，加入就地预览与编辑辅助能力。

核心原则：

- 阅读体验优先，编辑体验不牺牲效率。
- 渐进式替换，保证功能稳定。
- 每阶段可独立回滚。

## 4. 组件设计

### 4.1 渲染组件层

新增统一封装组件：MeetingMarkdownView

- 输入：markdown 文本、是否可选中、滚动控制器、样式密度。
- 输出：统一渲染结果。
- 责任：
  - 统一标题层级、列表间距、引用块、代码块、分割线样式。
  - 统一空内容占位逻辑。
  - 统一链接与复制交互行为。
	- 支持增量文本输入时的稳定重绘。

### 4.2 流式渲染协调层（新增）

新增协调器：MeetingMarkdownStreamController

- 输入：模型 chunk 流（SSE/event stream）。
- 输出：可渲染的 markdownSnapshot（逐步增长）。
- 责任：
	- chunk 聚合与最小刷新间隔控制（例如 50~120ms）。
	- 避免高频 setState 导致抖动。
	- 处理不完整 markdown 片段（代码块、列表）时的容错显示。
	- 流结束后输出 finalSnapshot 并触发持久化。

### 4.3 编辑组件层

新增统一封装组件：MeetingMarkdownEditor

- 模式：
  - 编辑模式：纯文本输入。
  - 预览模式：调用 MeetingMarkdownView。
  - 分屏模式（后续可选）：左编辑右预览。
- 能力：
  - 常用 Markdown 快捷插入（标题、列表、任务项）。
  - 自动保存草稿（页面级）。
  - 编辑后快速回到阅读态。

## 5. 分阶段实施计划

### 5.1 需要改造的会议视图清单（全量）

以下清单用于回答“会议各个视图中，凡是经过大模型处理的内容都要实时渲染”这一要求。

#### 视图 A：会议录制页（MeetingRecordingPage）

- 文件：`lib/screens/pages/meeting_recording_page.dart`
- 需要流式改造的区域：
	1. 合并纪要视图（`_buildMergedNoteArea`）
	2. 实时摘要视图（`_buildLiveSummaryArea`）
- 当前状态：
	- 合并纪要已接 `onStreamChunk`，但仍是“字符串拼接 + 直接重绘”，缺少统一节流与容错。
	- 实时摘要来自 `IncrementalSummaryService.onSummaryUpdated`，是“段级更新”而非 token/chunk 级流式。
- 改造要点：
	- 合并纪要接入 `MeetingMarkdownStreamController`，统一节流、容错、滚动策略。
	- 实时摘要链路改为支持 `enhanceStream`，实现边生成边渲染。

#### 视图 B：会议详情页（MeetingDetailPage）

- 文件：`lib/screens/pages/meeting_detail_page.dart`
- 需要流式改造的区域：
	1. 重新生成摘要按钮触发的摘要内容区域（`_regenerateSummary`）。
	2. 会议结束后后台 `finalizing` 期间的摘要/正文面板。
- 当前状态：
	- `_regenerateSummary` 走 `regenerateSummaryByContent`，为一次性返回。
	- `MeetingProvider` 内已有 `regenerateSummaryStream`，但页面未接入。
	- `finalizing` 有状态提示，但正文与摘要不是持续流式刷新体验。
- 改造要点：
	- 将 `_regenerateSummary` 切换为 `regenerateSummaryStream` 订阅。
	- 详情页在 `finalizing` 状态下支持增量刷新（摘要、正文）。
	- 加入“用户上滑后暂停自动滚动”的阅读保护。

#### 视图 C：会议列表页（MeetingListPage）

- 文件：`lib/screens/pages/meeting_list_page.dart`
- 需要流式改造的区域：
	1. 卡片摘要预览区（summary/fullTranscription 预览）。
	2. 处理中状态展示（recording/finalizing）。
- 当前状态：
	- 列表页展示的是数据库最新快照，未定义“流式进行中”的预览刷新策略。
- 改造要点：
	- 对 finalizing 会议卡片增加“流式更新中”视觉状态。
	- 在不影响性能的前提下，支持低频增量刷新预览文本（例如 300~500ms 节流）。

#### 视图 D：会议相关悬浮态/全局态（Overlay）

- 文件：`lib/services/overlay_service.dart`（会议流程相关调用在 `MeetingProvider`）
- 需要流式改造的区域：
	1. 处理中状态描述文本。
- 当前状态：
	- 有状态切换，但未承载 Markdown 流式内容的可视反馈。
- 改造要点：
	- 保持轻量：仅展示阶段和进度，不渲染大段 Markdown。
	- 避免与页面正文流式渲染冲突（Overlay 不承担正文渲染职责）。

### 5.2 需要改造的服务与状态层（支撑全视图）

#### Provider 层

- 文件：`lib/providers/meeting_provider.dart`
- 改造点：
	- 统一暴露流式状态：`isStreamingMerge`、`isStreamingSummary`、`isFinalizingMeeting`。
	- 将 `regenerateSummaryStream` 接入页面可消费事件（包括取消、完成、错误）。
	- 为列表页提供轻量增量预览字段（避免每次全量刷新 meeting 列表）。

#### 录制服务层

- 文件：`lib/services/meeting_recording_service.dart`
- 改造点：
	- 合并纪要继续使用 `onStreamChunk`，但输出进入统一 stream controller。
	- 增量摘要服务新增流式更新接口（当前以段级更新为主）。

#### 摘要服务层

- 文件：`lib/services/incremental_summary_service.dart`
- 改造点：
	- 新增 `onSummaryChunk`（或等价 stream）事件。
	- 保留 `onSummaryUpdated` 作为最终快照事件，兼容旧调用链。

### 5.3 视图改造完成定义（DoD）

- 录制页：合并纪要、实时摘要都可边生成边渲染。
- 详情页：重新生成摘要时用户可实时看到生成过程，不再“转圈后整段出现”。
- 列表页：finalizing 中的会议可看到低频更新预览与明确状态。
- 全链路：流式结束后页面内容与最终持久化一致。

### 阶段 A：基础接入与样式统一（P0）

目标：不改交互，仅替换渲染引擎并统一样式。

计划项：

1. 引入 flutter_smooth_markdown 依赖并完成平台可用性验证。
2. 创建 MeetingMarkdownView 组件。
3. 在以下页面替换现有 Markdown 渲染：
	- 会议详情页摘要区。
	- 会议详情页完整文稿阅读态。
	- 录制页合并纪要区与实时摘要区。
4. 建立统一样式规范：
	- 标题字号层级。
	- 正文字号与行高。
	- 列表缩进与间距。
	- 代码块与引用块视觉规范。

阶段验收：

- 同一段 Markdown 在三个页面视觉一致。
- 长文档滚动流畅，无明显卡顿。
- 无功能回归（复制、选择、详情页编辑保存路径正常）。

### 阶段 B：流式输出与增量渲染（P0）

目标：实现“模型边输出，页面边渲染”，消除整段等待。

计划项：

1. 新增 MeetingMarkdownStreamController。
2. 录制页接入流式渲染：
	- 合并纪要区：chunk 增量渲染。
	- 实时摘要区：chunk 增量渲染。
3. 详情页接入流式刷新（用于重新生成摘要场景）。
4. 增加刷新节流策略与光标/滚动策略：
	- 用户在底部时自动跟随。
	- 用户手动上滑后停止强制跳底。
5. 流结束统一收敛：
	- 标记完成状态。
	- 触发最终文本持久化。

阶段验收：

- 流式过程中 300ms 内可见首屏文本。
- 渲染无明显闪烁或段落抖动。
- 流式结束后文本与最终持久化内容一致。

### 阶段 C：编辑体验优化（P1）

目标：提升编辑效率和所见即所得一致性。

计划项：

1. 创建 MeetingMarkdownEditor。
2. 详情页编辑区支持编辑/预览切换。
3. 增加轻量工具栏：
	- 插入标题。
	- 插入有序/无序列表。
	- 插入任务项。
4. 编辑会话态草稿保护：
	- 页面内切换不丢内容。
	- 返回前二次确认（仅当有未保存改动）。

阶段验收：

- 编辑后预览效果与阅读态一致。
- 常见 Markdown 操作可在 2 次点击内完成。
- 未保存变更有明确提示。

### 阶段 D：质量增强与可观测性（P2）

目标：提高稳定性和可维护性。

计划项：

1. 增加渲染性能埋点：
	- 首次渲染耗时。
	- 长文本滚动帧率（采样）。
2. 增加典型文档快照测试样例：
	- 多级标题。
	- 长列表。
	- 代码块和引用嵌套。
3. 补充异常降级：
	- 渲染失败回退基础 Text 视图。

阶段验收：

- 关键页面渲染失败率可观测。
- 典型 Markdown 样例渲染稳定。

## 6. 技术风险与应对

### 风险 1：第三方组件样式与现有主题冲突

应对：

- 所有渲染入口只通过 MeetingMarkdownView。
- 禁止页面直接拼接样式，统一走主题映射。

### 风险 2：长文内容性能抖动

应对：

- 优先做只读态优化。
- 对超长文稿启用分段渲染策略（后续开关）。

### 风险 3：流式 chunk 导致 Markdown 结构临时不完整

应对：

- StreamController 做语法容错（未闭合代码块临时补全显示）。
- 在流结束时进行一次最终标准化渲染。

### 风险 4：编辑态迁移引入行为回归

应对：

- 先灰度到详情页单一区域。
- 编辑链路保留旧逻辑回退开关。

## 7. 评审关注点

请重点评审以下内容：

- 统一组件抽象是否合理（MeetingMarkdownView / MeetingMarkdownEditor）。
- 阶段 A 与阶段 B 的优先级是否符合当前迭代节奏。
- 是否需要在阶段 A 就加入部分编辑辅助能力。
- 样式规范是否符合产品当前的商务化视觉方向。

## 8. 里程碑建议

- M1（1 天）：阶段 A 完成并可回归。
- M2（1 天）：阶段 B 流式渲染链路完成并可回归。
- M3（1-2 天）：阶段 C 编辑体验改造完成。
- M4（0.5-1 天）：阶段 D 埋点与质量补齐。

总计建议工期：3.5 至 5 天（含联调与回归）。

